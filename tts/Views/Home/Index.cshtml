@{
    ViewData["Title"] = "Home Page";
}

<link rel="stylesheet" href="~/css/speech.css" />

<div class="text-center mb-4">
    <h1 class="display-4">Welcome</h1>
    <p>Learn about <a href="https://learn.microsoft.com/aspnet/core">building Web apps with ASP.NET Core</a>.</p>
</div>

<div class="container">
    <h2 class="text-center mb-4">Azure Text-to-Speech Demo</h2>
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="form-group">
                <label for="inputText">Enter text to convert to speech:</label>
                <textarea id="inputText" class="form-control" rows="4"></textarea>
            </div>
            <button id="convertButton" class="btn btn-primary btn-block mt-3">Convert to Speech</button>
            <div id="audioContainer" class="mt-3" style="display: none;">
                <audio id="audioPlayer" class="w-100" controls></audio>
            </div>
            <div id="speakingIndicator" class="mt-3" style="display: none;">
                <div class="speaking-dots">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
                <p class="text-center mt-2">Speaking...</p>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        $('#convertButton').click(function () {
            var text = $('#inputText').val();
            if (text) {
                $.ajax({
                    url: '/Home/ConvertToSpeech',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ text: text }),
                    success: function (data) {
                        var audio = $('#audioPlayer')[0];
                        var blob = new Blob([data], { type: 'audio/wav' });
                        var url = URL.createObjectURL(blob);
                        audio.src = url;
                        $('#audioContainer').show();
                        $('#speakingIndicator').show(); // Show indicator immediately

                        audio.onplay = function () {
                            $('#speakingIndicator').show();
                        };

                        audio.onpause = audio.onended = function () {
                            $('#speakingIndicator').hide();
                        };

                        // Automatically play the audio
                        audio.play().catch(function (error) {
                            console.log("Audio playback failed: ", error);
                        });
                    },
                    error: function () {
                        alert('Error converting text to speech.');
                    }
                });
            }
        });
    });
</script>
